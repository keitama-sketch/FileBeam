<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FileBeam Host</title>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    progress { width: 300px; height: 20px; }
    #status { margin-top: 10px; }
  </style>
</head>
<body>

<h2>FileBeam Host</h2>

<input type="text" id="id" placeholder="任意のID">
<button id="start">準備</button>

<div id="status"></div>

<h3>ファイル送信</h3>
<input type="file" id="fileInput" disabled>

<p>送信進捗</p>
<progress id="hostProgress" value="0" max="100"></progress>

<script>
let peer;
let conn;

const CHUNK_SIZE = 64 * 1024; // 64KB

document.getElementById("start").onclick = () => {
  const id = document.getElementById("id").value.trim();
  if (!id) return alert("IDを入力して");

  if (peer) peer.destroy();
  peer = new Peer(id);

  peer.on("open", myId => {
    document.getElementById("status").textContent = "SessionID: " + myId;
    document.getElementById("fileInput").disabled = false;
  });

  peer.on("connection", c => {
    conn = c;
    document.getElementById("status").textContent = "接続: " + conn.peer;

    conn.on("error", e => console.error(e));

    document.getElementById("fileInput").onchange = () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        const buffer = reader.result;
        const uint8 = new Uint8Array(buffer);

        conn.send({
          type: "meta",
          name: file.name,
          mime: file.type,
          size: uint8.length
        });

        let offset = 0;
        const bar = document.getElementById("hostProgress");

        function sendChunk() {
          const end = Math.min(offset + CHUNK_SIZE, uint8.length);
          const chunk = uint8.slice(offset, end);

          conn.send({ type: "chunk", data: chunk });

          offset = end;
          const percent = (offset / uint8.length) * 100;
          bar.value = percent;

          conn.send({ type: "progress", percent });

          if (offset < uint8.length) {
            setTimeout(sendChunk, 0);
          } else {
            conn.send({ type: "end" });
            bar.value = 100;
            document.getElementById("status").textContent = "送信完了: " + file.name;
          }
        }

        sendChunk();
      };

      reader.readAsArrayBuffer(file);
    };
  });

  peer.on("error", err => alert("PeerJS エラー: " + err));
};
</script>

</body>
</html>
